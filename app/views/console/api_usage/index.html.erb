<% content_for(:title) { "API 사용량 - Console | playwith404" } %>

<div class="flex min-h-screen bg-gray-50">
  <%= render "console/shared/sidebar" %>

  <main class="flex-1 p-8">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="heading-brutal text-3xl mb-2">API 사용량</h1>
      <p class="text-gray-600">API 호출 통계 및 트렌드를 분석하세요.</p>
    </div>

    <!-- Period Filter -->
    <div class="card-brutal bg-white mb-8">
      <div class="flex gap-4">
        <%= link_to "일별",
            console_api_usage_index_path(period: "daily"),
            class: "px-6 py-2 font-bold border-4 border-black transition-all #{@period == 'daily' ? 'bg-char-lemon' : 'bg-white hover:bg-gray-100'}" %>
        <%= link_to "주별",
            console_api_usage_index_path(period: "weekly"),
            class: "px-6 py-2 font-bold border-4 border-black transition-all #{@period == 'weekly' ? 'bg-char-lemon' : 'bg-white hover:bg-gray-100'}" %>
        <%= link_to "월별",
            console_api_usage_index_path(period: "monthly"),
            class: "px-6 py-2 font-bold border-4 border-black transition-all #{@period == 'monthly' ? 'bg-char-lemon' : 'bg-white hover:bg-gray-100'}" %>
      </div>
    </div>

    <!-- Stats Summary -->
    <div class="grid md:grid-cols-4 gap-6 mb-8">
      <%= render "console/shared/stats_card",
          title: "총 호출 수",
          value: number_with_delimiter(@usages.count),
          color: "char-lemon",
          icon: "📊" %>

      <%= render "console/shared/stats_card",
          title: "성공",
          value: number_with_delimiter(@usages.successful.count),
          color: "char-bean",
          icon: "✓" %>

      <%= render "console/shared/stats_card",
          title: "에러",
          value: number_with_delimiter(@usages.errors.count),
          color: "char-heart",
          icon: "✗" %>

      <% avg_time = @usages.average(:response_time_ms)&.round(0) || 0 %>
      <%= render "console/shared/stats_card",
          title: "평균 응답시간",
          value: "#{avg_time}ms",
          color: "char-ghost",
          icon: "⚡" %>
    </div>

    <!-- Chart -->
    <div class="card-brutal bg-white mb-8">
      <h3 class="font-bold text-xl mb-4">
        <%= case @period
            when "daily" then "시간대별"
            when "weekly" then "일별"
            when "monthly" then "일별"
            end %> API 호출량
      </h3>
      <div class="aspect-[21/9] bg-char-ghost/10 border-4 border-black p-4">
        <div class="h-full flex items-end justify-around gap-1">
          <% @chart_data[:calls].each_with_index do |calls, i| %>
            <div class="relative group w-full">
              <div class="bg-black hover:bg-char-lemon transition-all"
                   style="height: <%= calls.positive? ? [(calls.to_f / (@chart_data[:calls].max || 1) * 100), 5].max : 2 %>%">
              </div>
              <% if @chart_data[:errors][i].positive? %>
                <div class="absolute bottom-0 left-0 right-0 bg-red-500"
                     style="height: <%= (@chart_data[:errors][i].to_f / (@chart_data[:calls].max || 1) * 100) %>%">
                </div>
              <% end %>
              <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block bg-black text-white text-xs px-2 py-1 rounded whitespace-nowrap">
                <%= @chart_data[:labels][i] %>: <%= calls %> calls
              </div>
            </div>
          <% end %>
        </div>
      </div>
      <div class="flex justify-center gap-8 mt-4">
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-black border-2 border-black"></div>
          <span class="text-sm">성공</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-red-500 border-2 border-black"></div>
          <span class="text-sm">에러</span>
        </div>
      </div>
    </div>

    <!-- Breakdowns -->
    <div class="grid md:grid-cols-2 gap-8">
      <!-- Endpoint Breakdown -->
      <div class="card-brutal bg-white">
        <h3 class="font-bold text-xl mb-4">엔드포인트별 호출</h3>
        <div class="space-y-3 max-h-80 overflow-y-auto">
          <% if @endpoint_breakdown.any? %>
            <% max_count = @endpoint_breakdown.first&.last || 1 %>
            <% @endpoint_breakdown.each do |endpoint, count| %>
              <div class="space-y-1">
                <div class="flex justify-between">
                  <code class="text-sm bg-gray-100 px-2 py-1 rounded"><%= endpoint %></code>
                  <span class="font-bold"><%= number_with_delimiter(count) %></span>
                </div>
                <div class="h-2 bg-gray-200 border border-black">
                  <div class="h-full bg-char-lemon" style="width: <%= (count.to_f / max_count * 100).round(1) %>%"></div>
                </div>
              </div>
            <% end %>
          <% else %>
            <p class="text-gray-500 text-center py-4">데이터가 없습니다</p>
          <% end %>
        </div>
      </div>

      <!-- Response Code Breakdown -->
      <div class="card-brutal bg-white">
        <h3 class="font-bold text-xl mb-4">응답 코드별 분포</h3>
        <div class="space-y-3 max-h-80 overflow-y-auto">
          <% if @response_code_breakdown.any? %>
            <% max_count = @response_code_breakdown.first&.last || 1 %>
            <% @response_code_breakdown.each do |code, count| %>
              <% color_class = case code
                              when 200..299 then "bg-char-bean"
                              when 400..499 then "bg-yellow-300"
                              when 500..599 then "bg-red-300"
                              else "bg-gray-300"
                              end %>
              <div class="space-y-1">
                <div class="flex justify-between items-center">
                  <div class="flex items-center gap-2">
                    <span class="font-mono font-bold px-2 py-1 border-2 border-black <%= color_class %>">
                      <%= code %>
                    </span>
                    <span class="text-sm text-gray-600">
                      <%= case code
                          when 200 then "OK"
                          when 201 then "Created"
                          when 400 then "Bad Request"
                          when 401 then "Unauthorized"
                          when 403 then "Forbidden"
                          when 404 then "Not Found"
                          when 429 then "Rate Limited"
                          when 500 then "Server Error"
                          else ""
                          end %>
                    </span>
                  </div>
                  <span class="font-bold"><%= number_with_delimiter(count) %></span>
                </div>
                <div class="h-2 bg-gray-200 border border-black">
                  <div class="h-full <%= color_class %>" style="width: <%= (count.to_f / max_count * 100).round(1) %>%"></div>
                </div>
              </div>
            <% end %>
          <% else %>
            <p class="text-gray-500 text-center py-4">데이터가 없습니다</p>
          <% end %>
        </div>
      </div>
    </div>
  </main>
</div>
