name: Deploy to GCP

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  GCP_REGION: asia-northeast3
  IMAGE_NAME: cukee-web

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build Docker image
        run: |
          docker build \
            --build-arg RAILS_MASTER_KEY=${{ secrets.RAILS_MASTER_KEY }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cukee-world/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cukee-world/${{ env.IMAGE_NAME }}:latest \
            .

      - name: Push Docker image to Artifact Registry
        run: |
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cukee-world/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cukee-world/${{ env.IMAGE_NAME }}:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Compute Engine
        run: |
          gcloud compute ssh ${{ secrets.GCE_INSTANCE }} \
            --zone=${{ secrets.GCE_ZONE }} \
            --command="
              # Configure Docker for Artifact Registry
              gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

              # Pull the latest image
              docker pull ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cukee-world/${{ env.IMAGE_NAME }}:latest

              # Stop and remove existing container
              docker stop cukee-web || true
              docker rm cukee-web || true

              # Run new container
              docker run -d \
                --name cukee-web \
                --restart unless-stopped \
                -p 80:80 \
                -e RAILS_ENV=production \
                -e RAILS_MASTER_KEY=${{ secrets.RAILS_MASTER_KEY }} \
                -e DATABASE_URL='${{ secrets.DATABASE_URL }}' \
                -e RAILS_LOG_TO_STDOUT=true \
                -e RAILS_SERVE_STATIC_FILES=true \
                ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cukee-world/${{ env.IMAGE_NAME }}:latest

              # Run database migrations
              docker exec cukee-web ./bin/rails db:migrate

              # Clean up old images
              docker image prune -f
            "

      - name: Health check
        run: |
          sleep 10
          gcloud compute ssh ${{ secrets.GCE_INSTANCE }} \
            --zone=${{ secrets.GCE_ZONE }} \
            --command="curl -f http://localhost/up || exit 1"
