name: Deploy to GCP

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  GCP_REGION: us-west1
  IMAGE_NAME: cukee-web
  DEPLOY_PATH: ~/cukee-world

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build Docker image
        run: |
          docker build \
            --build-arg RAILS_MASTER_KEY=${{ secrets.RAILS_MASTER_KEY }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cukee-world/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cukee-world/${{ env.IMAGE_NAME }}:latest \
            .

      - name: Push Docker image to Artifact Registry
        run: |
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cukee-world/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cukee-world/${{ env.IMAGE_NAME }}:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Prepare deployment directory and copy files
        run: |
          # Create directory first via SSH
          gcloud compute ssh ${{ secrets.GCE_INSTANCE }} \
            --zone=${{ secrets.GCE_ZONE }} \
            --command="mkdir -p ~/cukee-world/nginx"

          # Copy files to home directory
          gcloud compute scp \
            --zone=${{ secrets.GCE_ZONE }} \
            --recurse \
            docker-compose.ssl.yml \
            nginx/ \
            scripts/ \
            ${{ secrets.GCE_INSTANCE }}:~/cukee-world/

      - name: Deploy with Docker Compose
        run: |
          gcloud compute ssh ${{ secrets.GCE_INSTANCE }} \
            --zone=${{ secrets.GCE_ZONE }} \
            --command='
              cd ~/cukee-world

              # Configure Docker for Artifact Registry
              gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

              # Create .env file with secrets
              cat > .env << EOF
          GCP_REGION=${{ env.GCP_REGION }}
          GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}
          IMAGE_TAG=latest
          RAILS_ENV=production
          RAILS_MASTER_KEY=${{ secrets.RAILS_MASTER_KEY }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          RAILS_LOG_TO_STDOUT=true
          RAILS_SERVE_STATIC_FILES=true
          SMTP_ADDRESS=${{ secrets.SMTP_ADDRESS }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}
          SMTP_USERNAME=${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}
          CONTACT_EMAIL=${{ secrets.SMTP_USERNAME }}
          MAILER_FROM_EMAIL=${{ secrets.SMTP_USERNAME }}
          EOF

              # Pull latest image
              docker compose -f docker-compose.ssl.yml pull web

              # Deploy with zero-downtime (if possible)
              docker compose -f docker-compose.ssl.yml up -d --remove-orphans

              # Run database migrations
              docker compose -f docker-compose.ssl.yml exec -T web ./bin/rails db:migrate

              # Clean up old images
              docker image prune -f
            '

      - name: Health check
        run: |
          sleep 15
          gcloud compute ssh ${{ secrets.GCE_INSTANCE }} \
            --zone=${{ secrets.GCE_ZONE }} \
            --command="curl -f http://localhost/up || curl -f https://localhost/up --insecure || exit 1"
